# Dev nginx reverse proxy (HTTP only) for local hot reload.
# Map subdomains to dev servers. Add to /etc/hosts:
# 127.0.0.1 app.jotti.rocks api.jotti.rocks
# (Or change server_name values to app.localhost / api.localhost.)

upstream frontend_dev {
  server frontend-dev:5173;
}

upstream backend_dev {
  server backend-dev:3000;
}

server {
  listen 80;
  server_name app.jotti.rocks;

  # Enforced CSP for dev (includes Vite HMR websocket & eval needs)
  add_header Content-Security-Policy "default-src 'none'; base-uri 'self'; frame-ancestors 'none'; form-action 'self'; script-src 'self' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self'; connect-src 'self' http://api.jotti.rocks ws://app.jotti.rocks:*; worker-src 'self' blob:; manifest-src 'self'; media-src 'self'; frame-src 'none'; object-src 'none'" always;

  location / {
    proxy_pass http://frontend_dev;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}

server {
  listen 80;
  server_name api.jotti.rocks;

  location / {
    proxy_pass http://backend_dev;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}
